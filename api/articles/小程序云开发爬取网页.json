{"title":"微信小程序云开发爬取网页","slug":"小程序云开发爬取网页","date":"2018-10-19T07:35:58.000Z","updated":"2018-11-28T03:36:07.939Z","comments":true,"path":"api/articles/小程序云开发爬取网页.json","excerpt":null,"covers":null,"content":"<blockquote>\n<p>云开发<br>got<br>cheerio</p>\n</blockquote>\n<hr>\n<ol>\n<li>新建云函数</li>\n<li>安装got依赖</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install got</span><br><span class=\"line\">npm install cheerio</span><br></pre></td></tr></table></figure>\n<ol start=\"3\">\n<li>首先爬取网站的新闻链接和title</li>\n</ol>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 云函数入口文件</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> cloud = <span class=\"built_in\">require</span>(<span class=\"string\">'wx-server-sdk'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> got = <span class=\"built_in\">require</span>(<span class=\"string\">'got'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> cheerio = <span class=\"built_in\">require</span>(<span class=\"string\">'cheerio'</span>)</span><br><span class=\"line\">cloud.init()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 云函数入口函数</span></span><br><span class=\"line\">exports.main = <span class=\"keyword\">async</span>(event, context) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> date = []</span><br><span class=\"line\">  <span class=\"keyword\">const</span> url = event.url</span><br><span class=\"line\">  <span class=\"keyword\">const</span> html = <span class=\"keyword\">await</span> got(url);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> $ = cheerio.load(html.body);</span><br><span class=\"line\">  $(<span class=\"string\">\".view_sidebar a\"</span>).slice(<span class=\"number\">0</span>, <span class=\"number\">5</span>).each(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">index</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//补全链接</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> newurl = <span class=\"string\">'http://www.peihua.cn/pgxy/'</span> + $(<span class=\"keyword\">this</span>).attr(<span class=\"string\">\"href\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">var</span> title = $(<span class=\"keyword\">this</span>).attr(<span class=\"string\">\"title\"</span>)</span><br><span class=\"line\">    date.push(&#123;</span><br><span class=\"line\">      title,</span><br><span class=\"line\">      url:newurl</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(date)</span><br><span class=\"line\">  <span class=\"keyword\">return</span> date</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ol start=\"4\">\n<li>为了加载快速，我选择了分开获取，先爬取链接，再爬取文章。</li>\n</ol>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 云函数入口文件</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> cloud = <span class=\"built_in\">require</span>(<span class=\"string\">'wx-server-sdk'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> got = <span class=\"built_in\">require</span>(<span class=\"string\">'got'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> cheerio = <span class=\"built_in\">require</span>(<span class=\"string\">'cheerio'</span>)</span><br><span class=\"line\">cloud.init()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 云函数入口函数</span></span><br><span class=\"line\">exports.main = <span class=\"keyword\">async</span> (event, context) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> date = []</span><br><span class=\"line\">  <span class=\"keyword\">const</span> url = event.url</span><br><span class=\"line\">  <span class=\"keyword\">const</span> html = <span class=\"keyword\">await</span> got(url);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> $ = cheerio.load(html.body, &#123; <span class=\"attr\">decodeEntities</span>: <span class=\"literal\">false</span> &#125;);</span><br><span class=\"line\">  <span class=\"keyword\">let</span> newshtml = $(<span class=\"string\">\".view_sidebar\"</span>).html();</span><br><span class=\"line\">  <span class=\"keyword\">return</span> newshtml</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>注意：在这里如果不加<code>{ decodeEntities: false }</code>，爬下来的div标签中汉字会乱码。</p>\n<ol start=\"5\">\n<li>小程序端加载富文本推荐<code>wxParser</code>插件</li>\n</ol>\n<hr>\n<p>参考文章：</p>\n<ol>\n<li><a href=\"https://github.com/cheeriojs/cheerio\" target=\"_blank\" rel=\"noopener\">cheerio</a></li>\n<li><a href=\"https://github.com/sindresorhus/got\" target=\"_blank\" rel=\"noopener\">got</a></li>\n<li><a href=\"https://github.com/ifanrx/wxParser\" target=\"_blank\" rel=\"noopener\">wxParser</a></li>\n<li><a href=\"https://www.jb51.net/article/60967.htm\" target=\"_blank\" rel=\"noopener\">Node.js抓取中文网页乱码问题和解决方法</a></li>\n</ol>\n","more":"<blockquote>\n<p>云开发<br>got<br>cheerio</p>\n</blockquote>\n<hr>\n<ol>\n<li>新建云函数</li>\n<li>安装got依赖</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install got</span><br><span class=\"line\">npm install cheerio</span><br></pre></td></tr></table></figure>\n<ol start=\"3\">\n<li>首先爬取网站的新闻链接和title</li>\n</ol>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 云函数入口文件</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> cloud = <span class=\"built_in\">require</span>(<span class=\"string\">'wx-server-sdk'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> got = <span class=\"built_in\">require</span>(<span class=\"string\">'got'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> cheerio = <span class=\"built_in\">require</span>(<span class=\"string\">'cheerio'</span>)</span><br><span class=\"line\">cloud.init()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 云函数入口函数</span></span><br><span class=\"line\">exports.main = <span class=\"keyword\">async</span>(event, context) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> date = []</span><br><span class=\"line\">  <span class=\"keyword\">const</span> url = event.url</span><br><span class=\"line\">  <span class=\"keyword\">const</span> html = <span class=\"keyword\">await</span> got(url);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> $ = cheerio.load(html.body);</span><br><span class=\"line\">  $(<span class=\"string\">\".view_sidebar a\"</span>).slice(<span class=\"number\">0</span>, <span class=\"number\">5</span>).each(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">index</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//补全链接</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> newurl = <span class=\"string\">'http://www.peihua.cn/pgxy/'</span> + $(<span class=\"keyword\">this</span>).attr(<span class=\"string\">\"href\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">var</span> title = $(<span class=\"keyword\">this</span>).attr(<span class=\"string\">\"title\"</span>)</span><br><span class=\"line\">    date.push(&#123;</span><br><span class=\"line\">      title,</span><br><span class=\"line\">      url:newurl</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(date)</span><br><span class=\"line\">  <span class=\"keyword\">return</span> date</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ol start=\"4\">\n<li>为了加载快速，我选择了分开获取，先爬取链接，再爬取文章。</li>\n</ol>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 云函数入口文件</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> cloud = <span class=\"built_in\">require</span>(<span class=\"string\">'wx-server-sdk'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> got = <span class=\"built_in\">require</span>(<span class=\"string\">'got'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> cheerio = <span class=\"built_in\">require</span>(<span class=\"string\">'cheerio'</span>)</span><br><span class=\"line\">cloud.init()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 云函数入口函数</span></span><br><span class=\"line\">exports.main = <span class=\"keyword\">async</span> (event, context) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> date = []</span><br><span class=\"line\">  <span class=\"keyword\">const</span> url = event.url</span><br><span class=\"line\">  <span class=\"keyword\">const</span> html = <span class=\"keyword\">await</span> got(url);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> $ = cheerio.load(html.body, &#123; <span class=\"attr\">decodeEntities</span>: <span class=\"literal\">false</span> &#125;);</span><br><span class=\"line\">  <span class=\"keyword\">let</span> newshtml = $(<span class=\"string\">\".view_sidebar\"</span>).html();</span><br><span class=\"line\">  <span class=\"keyword\">return</span> newshtml</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>注意：在这里如果不加<code>{ decodeEntities: false }</code>，爬下来的div标签中汉字会乱码。</p>\n<ol start=\"5\">\n<li>小程序端加载富文本推荐<code>wxParser</code>插件</li>\n</ol>\n<hr>\n<p>参考文章：</p>\n<ol>\n<li><a href=\"https://github.com/cheeriojs/cheerio\" target=\"_blank\" rel=\"noopener\">cheerio</a></li>\n<li><a href=\"https://github.com/sindresorhus/got\" target=\"_blank\" rel=\"noopener\">got</a></li>\n<li><a href=\"https://github.com/ifanrx/wxParser\" target=\"_blank\" rel=\"noopener\">wxParser</a></li>\n<li><a href=\"https://www.jb51.net/article/60967.htm\" target=\"_blank\" rel=\"noopener\">Node.js抓取中文网页乱码问题和解决方法</a></li>\n</ol>\n","categories":[],"tags":[{"name":"微信小程序","path":"api/tags/微信小程序.json"}]}