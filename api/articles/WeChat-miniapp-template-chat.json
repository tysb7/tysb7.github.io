{"title":"微信小程序云开发模版消息(无限下发)","slug":"WeChat-miniapp-template-chat","date":"2018-11-26T06:29:41.000Z","updated":"2018-11-28T06:11:27.338Z","comments":true,"path":"api/articles/WeChat-miniapp-template-chat.json","excerpt":null,"covers":["https://blogimg-1252809090.cos.ap-chengdu.myqcloud.com/WeChat_miniapp_template_chat/IMG.jpg"],"content":"<h1 id=\"微信小程序云开发——模版消息聊天\"><a href=\"#微信小程序云开发——模版消息聊天\" class=\"headerlink\" title=\"微信小程序云开发——模版消息聊天\"></a>微信小程序云开发——模版消息聊天</h1><ul>\n<li>在小程序中大量储存formId</li>\n<li>使用云开发下发模版消息</li>\n<li>使用模版消息相互聊天</li>\n</ul>\n<h2 id=\"项目\"><a href=\"#项目\" class=\"headerlink\" title=\"项目\"></a>项目</h2><p>项目地址：<a href=\"https://github.com/tysb7/WeChat_miniapp_template_chat\" target=\"_blank\" rel=\"noopener\">https://github.com/tysb7/WeChat_miniapp_template_chat</a></p>\n<h2 id=\"截图\"><a href=\"#截图\" class=\"headerlink\" title=\"截图\"></a>截图</h2><p><img src=\"https://blogimg-1252809090.cos.ap-chengdu.myqcloud.com/WeChat_miniapp_template_chat/IMG.jpg\" alt></p>\n<h2 id=\"结构\"><a href=\"#结构\" class=\"headerlink\" title=\"结构\"></a>结构</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">├─cloudfunctions </span><br><span class=\"line\">│  ├─login</span><br><span class=\"line\">│  |   └─index.js</span><br><span class=\"line\">│  ├─moban</span><br><span class=\"line\">|  |   ├─index.js</span><br><span class=\"line\">│  |   ├─package-lock.json</span><br><span class=\"line\">│  |   └─package.json  </span><br><span class=\"line\">│  └─remove</span><br><span class=\"line\">|      ├─index.js</span><br><span class=\"line\">│      ├─package-lock.json</span><br><span class=\"line\">│      └─package.json           　　</span><br><span class=\"line\">├─miniprogram</span><br><span class=\"line\">│  ├─app.js</span><br><span class=\"line\">│  ├─app.json</span><br><span class=\"line\">│  ├─app.wxss</span><br><span class=\"line\">│  └─pages</span><br><span class=\"line\">│      └─fromId</span><br><span class=\"line\">│         ├─index.wxml</span><br><span class=\"line\">│         ├─index.js</span><br><span class=\"line\">│         ├─index.json</span><br><span class=\"line\">│         └─index.wxss</span><br><span class=\"line\">└─project.config.json</span><br></pre></td></tr></table></figure>\n<h2 id=\"云开发下发模版消息\"><a href=\"#云开发下发模版消息\" class=\"headerlink\" title=\"云开发下发模版消息\"></a>云开发下发模版消息</h2><p><a href=\"http://www.tysb7.cn/2018/10/15/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%BA%91%E5%BC%80%E5%8F%91%E6%A8%A1%E7%89%88%E6%B6%88%E6%81%AF/\" target=\"_blank\" rel=\"noopener\">详细请移步之前文章</a></p>\n<h2 id=\"思路\"><a href=\"#思路\" class=\"headerlink\" title=\"思路\"></a>思路</h2><ol>\n<li>在前端中需要大量获取formId，将获取到的formID打上时间戳和用户openid存储到数据库</li>\n<li>由于formId只有7天时效，所以需要打上时间戳，定期将7天前的数据删除掉</li>\n<li>在使用的时候通过目标用户openid获取formId，使用对应的openid和formId下发模版消息</li>\n<li>每使用一个/无效的formId，需要将其删掉</li>\n</ol>\n<h2 id=\"使用Demo\"><a href=\"#使用Demo\" class=\"headerlink\" title=\"使用Demo\"></a>使用Demo</h2><ol>\n<li>修改project.config.json中<code>appid</code></li>\n<li>修改miniprogram=&gt;app.js中<code>env</code>为自己的云开发环境</li>\n<li>上传cloudfunctions中的三个云函数</li>\n<li>修改cloudfunctions=&gt;moban=&gt;index.js中的<code>APPID</code>和<code>SECRET</code></li>\n<li>申请模版消息并修改模版消息<code>ID</code></li>\n</ol>\n<h2 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h2><p>index.wxml</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">report-submit</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">bindsubmit</span>=<span class=\"string\">\"button_three\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">formType</span>=<span class=\"string\">\"submit\"</span>&gt;</span>存储formId<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">report-submit</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">bindsubmit</span>=<span class=\"string\">\"button_one\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">formType</span>=<span class=\"string\">\"submit\"</span>&gt;</span>发给自己模版消息<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">report-submit</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">bindsubmit</span>=<span class=\"string\">\"button_two\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">view</span> <span class=\"attr\">class</span>=<span class=\"string\">\"section\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">style</span>=<span class=\"string\">'font-size:30rpx;text-align: center;line-height:100rpx;margin:30rpx;'</span> <span class=\"attr\">name</span>=<span class=\"string\">\"input\"</span> <span class=\"attr\">placeholder</span>=<span class=\"string\">\"please input here\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">view</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">formType</span>=<span class=\"string\">\"submit\"</span>&gt;</span>发给别人模版消息<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">view</span> <span class=\"attr\">style</span>=<span class=\"string\">'margin:100rpx;'</span> <span class=\"attr\">hidden</span>=<span class=\"string\">'&#123;&#123;receiveDataShow&#125;&#125;'</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">view</span>&gt;</span>收到&#123;&#123;receiveData.sender_openid&#125;&#125;的消息:<span class=\"tag\">&lt;/<span class=\"name\">view</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">view</span> <span class=\"attr\">style</span>=<span class=\"string\">'font-size:50rpx;text-align: center;line-height:100rpx;'</span>&gt;</span>&#123;&#123;receiveData.value&#125;&#125;<span class=\"tag\">&lt;/<span class=\"name\">view</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">report-submit</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">bindsubmit</span>=<span class=\"string\">\"receive\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">view</span> <span class=\"attr\">class</span>=<span class=\"string\">\"section\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">style</span>=<span class=\"string\">'font-size:30rpx;text-align: center;line-height:100rpx;margin:30rpx;'</span> <span class=\"attr\">name</span>=<span class=\"string\">\"input\"</span> <span class=\"attr\">placeholder</span>=<span class=\"string\">\"please input here\"</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">view</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">formType</span>=<span class=\"string\">\"submit\"</span>&gt;</span>回复消息<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">view</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>index.js</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> db = wx.cloud.database();</span><br><span class=\"line\"><span class=\"keyword\">const</span> _ = db.command;</span><br><span class=\"line\">Page(&#123;</span><br><span class=\"line\">  data: &#123;</span><br><span class=\"line\">    receiveDataShow: <span class=\"literal\">true</span> <span class=\"comment\">//接收框开关</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * 生命周期函数--监听页面加载</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  onLoad: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">options</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> that = <span class=\"keyword\">this</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (options.sender_openid) &#123;</span><br><span class=\"line\">      that.setData(&#123;</span><br><span class=\"line\">        receiveData: options, <span class=\"comment\">//接收数据</span></span><br><span class=\"line\">        receiveDataShow: <span class=\"literal\">false</span> <span class=\"comment\">//打开接受信息页面</span></span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log((<span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>()).valueOf())</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>() - (<span class=\"number\">1000</span> * <span class=\"number\">60</span> * <span class=\"number\">60</span> * <span class=\"number\">24</span> * <span class=\"number\">7</span>))</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>(<span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>() - (<span class=\"number\">1000</span> * <span class=\"number\">60</span> * <span class=\"number\">60</span> * <span class=\"number\">24</span> * <span class=\"number\">7</span>)))</span><br><span class=\"line\">    <span class=\"comment\">//调用云函数获取openid</span></span><br><span class=\"line\">    wx.cloud.callFunction(&#123;</span><br><span class=\"line\">      name: <span class=\"string\">'login'</span>,</span><br><span class=\"line\">      data: &#123;&#125;,</span><br><span class=\"line\">      success: <span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">'[云函数] [login] user openid: '</span>, res.result.openid)</span><br><span class=\"line\">        wx.setStorageSync(<span class=\"string\">\"openid\"</span>, res.result.openid)</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      fail: <span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.error(<span class=\"string\">'[云函数] [login] 调用失败'</span>, err)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * 生命周期函数--监听页面初次渲染完成</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  onReady: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"comment\">//发送给自己模版消息</span></span><br><span class=\"line\">  button_one(e) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> form_id = e.detail.formId</span><br><span class=\"line\">    <span class=\"keyword\">let</span> date = <span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> data = <span class=\"built_in\">JSON</span>.stringify(&#123;</span><br><span class=\"line\">      <span class=\"string\">\"keyword1\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"value\"</span>: date</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">\"keyword2\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"value\"</span>: <span class=\"string\">\"2015年01月05日 12:30\"</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    <span class=\"comment\">//调用云函数发送模版消息</span></span><br><span class=\"line\">    wx.cloud.callFunction(&#123;</span><br><span class=\"line\">      name: <span class=\"string\">'moban'</span>,</span><br><span class=\"line\">      data: &#123;</span><br><span class=\"line\">        openid: wx.getStorageSync(<span class=\"string\">\"openid\"</span>),</span><br><span class=\"line\">        template_id: <span class=\"string\">\"Lwh1NYwTUzHIjDwWlbPVhUJWQLW__nLkj31p2lMH8AM\"</span>,</span><br><span class=\"line\">        page: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">        form_id,</span><br><span class=\"line\">        data,</span><br><span class=\"line\">        emphasis_keyword: <span class=\"string\">\"keyword1.DATA\"</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      success: <span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">'[云函数] [login] : '</span>, res)</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      fail: <span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.error(<span class=\"string\">'[云函数] [login] 调用失败'</span>, err)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"comment\">//调用云函数发送给指定用户</span></span><br><span class=\"line\">  button_two(e) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(e.detail.value.input)</span><br><span class=\"line\">    <span class=\"keyword\">let</span> value = e.detail.value.input <span class=\"comment\">//获取输入</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> week = <span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>() - (<span class=\"number\">1000</span> * <span class=\"number\">60</span> * <span class=\"number\">60</span> * <span class=\"number\">24</span> * <span class=\"number\">7</span>) <span class=\"comment\">//建立7天时间戳</span></span><br><span class=\"line\">    <span class=\"comment\">//储存formId，并打时间戳</span></span><br><span class=\"line\">    db.collection(<span class=\"string\">'formId'</span>).add(&#123;</span><br><span class=\"line\">        data: &#123;</span><br><span class=\"line\">          openid: wx.getStorageSync(<span class=\"string\">\"openid\"</span>),</span><br><span class=\"line\">          formId: e.detail.formId,</span><br><span class=\"line\">          date: (<span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>()).valueOf()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      .then(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(res)</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    <span class=\"comment\">//获取formId数据 </span></span><br><span class=\"line\">    db.collection(<span class=\"string\">'formId'</span>).where(&#123;</span><br><span class=\"line\">      _openid: <span class=\"string\">\"ogff70LGj__6xlA_lXbB-KoBWEo0\"</span>,</span><br><span class=\"line\">      date: _.gt(week) <span class=\"comment\">//获取7天内</span></span><br><span class=\"line\">    &#125;).get().then(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"built_in\">console</span>.log(res.data)</span><br><span class=\"line\">      <span class=\"keyword\">var</span> formIdList = res.data</span><br><span class=\"line\">      <span class=\"keyword\">let</span> date = <span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>();</span><br><span class=\"line\">      <span class=\"keyword\">let</span> data = <span class=\"built_in\">JSON</span>.stringify(&#123;</span><br><span class=\"line\">        <span class=\"string\">\"keyword1\"</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">\"value\"</span>: value</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">\"keyword2\"</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">\"value\"</span>: date</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      <span class=\"comment\">//调用云函数发送模版消息</span></span><br><span class=\"line\">      wx.cloud.callFunction(&#123;</span><br><span class=\"line\">        name: <span class=\"string\">'moban'</span>,</span><br><span class=\"line\">        data: &#123;</span><br><span class=\"line\">          openid: formIdList[<span class=\"number\">0</span>].openid,</span><br><span class=\"line\">          template_id: <span class=\"string\">\"Lwh1NYwTUzHIjDwWlbPVhUJWQLW__nLkj31p2lMH8AM\"</span>,</span><br><span class=\"line\">          page: <span class=\"string\">\"/pages/fromID/index?sender_openid=\"</span> + wx.getStorageSync(<span class=\"string\">\"openid\"</span>) + <span class=\"string\">\"&amp;value=\"</span> + value, <span class=\"comment\">//携带参数</span></span><br><span class=\"line\">          form_id: formIdList[<span class=\"number\">0</span>].formId,</span><br><span class=\"line\">          data,</span><br><span class=\"line\">          emphasis_keyword: <span class=\"string\">\"keyword1.DATA\"</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        success: <span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"built_in\">console</span>.log(<span class=\"string\">'模版消息发送成功: '</span>, res)</span><br><span class=\"line\">          <span class=\"keyword\">this</span>.remove(formIdList[<span class=\"number\">0</span>]._id); <span class=\"comment\">//调用删除formId函数</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail: <span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"built_in\">console</span>.error(<span class=\"string\">'模版消息发送失败：'</span>, err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  button_three(e) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(e.detail.formId)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>())</span><br><span class=\"line\">    db.collection(<span class=\"string\">'formId'</span>).add(&#123;</span><br><span class=\"line\">        data: &#123;</span><br><span class=\"line\">          openid: wx.getStorageSync(<span class=\"string\">\"openid\"</span>),</span><br><span class=\"line\">          formId: e.detail.formId,</span><br><span class=\"line\">          date: (<span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>()).valueOf()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      .then(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(res)</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"comment\">//回复消息</span></span><br><span class=\"line\">  receive(e) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(e.detail.value.input)</span><br><span class=\"line\">    <span class=\"keyword\">let</span> value = e.detail.value.input</span><br><span class=\"line\">    <span class=\"keyword\">let</span> week = <span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>() - (<span class=\"number\">1000</span> * <span class=\"number\">60</span> * <span class=\"number\">60</span> * <span class=\"number\">24</span> * <span class=\"number\">7</span>)</span><br><span class=\"line\">    db.collection(<span class=\"string\">'formId'</span>).add(&#123;</span><br><span class=\"line\">        data: &#123;</span><br><span class=\"line\">          openid: wx.getStorageSync(<span class=\"string\">\"openid\"</span>),</span><br><span class=\"line\">          formId: e.detail.formId,</span><br><span class=\"line\">          date: (<span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>()).valueOf()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      .then(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(res)</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    db.collection(<span class=\"string\">'formId'</span>).where(&#123;</span><br><span class=\"line\">      _openid: <span class=\"keyword\">this</span>.data.receiveData.sender_openid,</span><br><span class=\"line\">      date: _.gt(week)</span><br><span class=\"line\">    &#125;).get().then(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"built_in\">console</span>.log(res.data)</span><br><span class=\"line\">      <span class=\"keyword\">var</span> formIdList = res.data</span><br><span class=\"line\">      <span class=\"keyword\">let</span> date = <span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>();</span><br><span class=\"line\">      <span class=\"keyword\">let</span> data = <span class=\"built_in\">JSON</span>.stringify(&#123;</span><br><span class=\"line\">        <span class=\"string\">\"keyword1\"</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">\"value\"</span>: value</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">\"keyword2\"</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">\"value\"</span>: date</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      wx.cloud.callFunction(&#123;</span><br><span class=\"line\">        name: <span class=\"string\">'moban'</span>,</span><br><span class=\"line\">        data: &#123;</span><br><span class=\"line\">          openid: formIdList[<span class=\"number\">0</span>].openid,</span><br><span class=\"line\">          template_id: <span class=\"string\">\"Lwh1NYwTUzHIjDwWlbPVhUJWQLW__nLkj31p2lMH8AM\"</span>,</span><br><span class=\"line\">          page: <span class=\"string\">\"/pages/fromID/index?sender_openid=\"</span> + wx.getStorageSync(<span class=\"string\">\"openid\"</span>) + <span class=\"string\">\"&amp;value=\"</span> + value,</span><br><span class=\"line\">          form_id: formIdList[<span class=\"number\">0</span>].formId,</span><br><span class=\"line\">          data,</span><br><span class=\"line\">          emphasis_keyword: <span class=\"string\">\"keyword1.DATA\"</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        success: <span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"built_in\">console</span>.log(<span class=\"string\">'模版消息发送成功: '</span>, res)</span><br><span class=\"line\">          <span class=\"keyword\">this</span>.remove(formIdList[<span class=\"number\">0</span>]._id);</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail: <span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"built_in\">console</span>.error(<span class=\"string\">'模版消息发送失败：'</span>, err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"comment\">//调用云函数删除使用过的formId数据</span></span><br><span class=\"line\">  remove(id) &#123;</span><br><span class=\"line\">    wx.cloud.callFunction(&#123;</span><br><span class=\"line\">      name: <span class=\"string\">'remove'</span>,</span><br><span class=\"line\">      data: &#123;</span><br><span class=\"line\">        id,</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      success: <span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">'删除成功：'</span>, res)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (res.result.stats.removed == <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">          wx.showToast(&#123;</span><br><span class=\"line\">            title: <span class=\"string\">'删除formId成功'</span>,</span><br><span class=\"line\">          &#125;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      fail: <span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">'删除失败：'</span>, err)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n","more":"<h1 id=\"微信小程序云开发——模版消息聊天\"><a href=\"#微信小程序云开发——模版消息聊天\" class=\"headerlink\" title=\"微信小程序云开发——模版消息聊天\"></a>微信小程序云开发——模版消息聊天</h1><ul>\n<li>在小程序中大量储存formId</li>\n<li>使用云开发下发模版消息</li>\n<li>使用模版消息相互聊天</li>\n</ul>\n<h2 id=\"项目\"><a href=\"#项目\" class=\"headerlink\" title=\"项目\"></a>项目</h2><p>项目地址：<a href=\"https://github.com/tysb7/WeChat_miniapp_template_chat\" target=\"_blank\" rel=\"noopener\">https://github.com/tysb7/WeChat_miniapp_template_chat</a></p>\n<h2 id=\"截图\"><a href=\"#截图\" class=\"headerlink\" title=\"截图\"></a>截图</h2><p><img src=\"https://blogimg-1252809090.cos.ap-chengdu.myqcloud.com/WeChat_miniapp_template_chat/IMG.jpg\" alt></p>\n<h2 id=\"结构\"><a href=\"#结构\" class=\"headerlink\" title=\"结构\"></a>结构</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">├─cloudfunctions </span><br><span class=\"line\">│  ├─login</span><br><span class=\"line\">│  |   └─index.js</span><br><span class=\"line\">│  ├─moban</span><br><span class=\"line\">|  |   ├─index.js</span><br><span class=\"line\">│  |   ├─package-lock.json</span><br><span class=\"line\">│  |   └─package.json  </span><br><span class=\"line\">│  └─remove</span><br><span class=\"line\">|      ├─index.js</span><br><span class=\"line\">│      ├─package-lock.json</span><br><span class=\"line\">│      └─package.json           　　</span><br><span class=\"line\">├─miniprogram</span><br><span class=\"line\">│  ├─app.js</span><br><span class=\"line\">│  ├─app.json</span><br><span class=\"line\">│  ├─app.wxss</span><br><span class=\"line\">│  └─pages</span><br><span class=\"line\">│      └─fromId</span><br><span class=\"line\">│         ├─index.wxml</span><br><span class=\"line\">│         ├─index.js</span><br><span class=\"line\">│         ├─index.json</span><br><span class=\"line\">│         └─index.wxss</span><br><span class=\"line\">└─project.config.json</span><br></pre></td></tr></table></figure>\n<h2 id=\"云开发下发模版消息\"><a href=\"#云开发下发模版消息\" class=\"headerlink\" title=\"云开发下发模版消息\"></a>云开发下发模版消息</h2><p><a href=\"http://www.tysb7.cn/2018/10/15/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%BA%91%E5%BC%80%E5%8F%91%E6%A8%A1%E7%89%88%E6%B6%88%E6%81%AF/\" target=\"_blank\" rel=\"noopener\">详细请移步之前文章</a></p>\n<h2 id=\"思路\"><a href=\"#思路\" class=\"headerlink\" title=\"思路\"></a>思路</h2><ol>\n<li>在前端中需要大量获取formId，将获取到的formID打上时间戳和用户openid存储到数据库</li>\n<li>由于formId只有7天时效，所以需要打上时间戳，定期将7天前的数据删除掉</li>\n<li>在使用的时候通过目标用户openid获取formId，使用对应的openid和formId下发模版消息</li>\n<li>每使用一个/无效的formId，需要将其删掉</li>\n</ol>\n<h2 id=\"使用Demo\"><a href=\"#使用Demo\" class=\"headerlink\" title=\"使用Demo\"></a>使用Demo</h2><ol>\n<li>修改project.config.json中<code>appid</code></li>\n<li>修改miniprogram=&gt;app.js中<code>env</code>为自己的云开发环境</li>\n<li>上传cloudfunctions中的三个云函数</li>\n<li>修改cloudfunctions=&gt;moban=&gt;index.js中的<code>APPID</code>和<code>SECRET</code></li>\n<li>申请模版消息并修改模版消息<code>ID</code></li>\n</ol>\n<h2 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h2><p>index.wxml</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">report-submit</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">bindsubmit</span>=<span class=\"string\">\"button_three\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">formType</span>=<span class=\"string\">\"submit\"</span>&gt;</span>存储formId<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">report-submit</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">bindsubmit</span>=<span class=\"string\">\"button_one\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">formType</span>=<span class=\"string\">\"submit\"</span>&gt;</span>发给自己模版消息<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">report-submit</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">bindsubmit</span>=<span class=\"string\">\"button_two\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">view</span> <span class=\"attr\">class</span>=<span class=\"string\">\"section\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">style</span>=<span class=\"string\">'font-size:30rpx;text-align: center;line-height:100rpx;margin:30rpx;'</span> <span class=\"attr\">name</span>=<span class=\"string\">\"input\"</span> <span class=\"attr\">placeholder</span>=<span class=\"string\">\"please input here\"</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">view</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">formType</span>=<span class=\"string\">\"submit\"</span>&gt;</span>发给别人模版消息<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">view</span> <span class=\"attr\">style</span>=<span class=\"string\">'margin:100rpx;'</span> <span class=\"attr\">hidden</span>=<span class=\"string\">'&#123;&#123;receiveDataShow&#125;&#125;'</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">view</span>&gt;</span>收到&#123;&#123;receiveData.sender_openid&#125;&#125;的消息:<span class=\"tag\">&lt;/<span class=\"name\">view</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">view</span> <span class=\"attr\">style</span>=<span class=\"string\">'font-size:50rpx;text-align: center;line-height:100rpx;'</span>&gt;</span>&#123;&#123;receiveData.value&#125;&#125;<span class=\"tag\">&lt;/<span class=\"name\">view</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">report-submit</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">bindsubmit</span>=<span class=\"string\">\"receive\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">view</span> <span class=\"attr\">class</span>=<span class=\"string\">\"section\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">style</span>=<span class=\"string\">'font-size:30rpx;text-align: center;line-height:100rpx;margin:30rpx;'</span> <span class=\"attr\">name</span>=<span class=\"string\">\"input\"</span> <span class=\"attr\">placeholder</span>=<span class=\"string\">\"please input here\"</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">view</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">formType</span>=<span class=\"string\">\"submit\"</span>&gt;</span>回复消息<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">view</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>index.js</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> db = wx.cloud.database();</span><br><span class=\"line\"><span class=\"keyword\">const</span> _ = db.command;</span><br><span class=\"line\">Page(&#123;</span><br><span class=\"line\">  data: &#123;</span><br><span class=\"line\">    receiveDataShow: <span class=\"literal\">true</span> <span class=\"comment\">//接收框开关</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * 生命周期函数--监听页面加载</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  onLoad: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">options</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> that = <span class=\"keyword\">this</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (options.sender_openid) &#123;</span><br><span class=\"line\">      that.setData(&#123;</span><br><span class=\"line\">        receiveData: options, <span class=\"comment\">//接收数据</span></span><br><span class=\"line\">        receiveDataShow: <span class=\"literal\">false</span> <span class=\"comment\">//打开接受信息页面</span></span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log((<span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>()).valueOf())</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>() - (<span class=\"number\">1000</span> * <span class=\"number\">60</span> * <span class=\"number\">60</span> * <span class=\"number\">24</span> * <span class=\"number\">7</span>))</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>(<span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>() - (<span class=\"number\">1000</span> * <span class=\"number\">60</span> * <span class=\"number\">60</span> * <span class=\"number\">24</span> * <span class=\"number\">7</span>)))</span><br><span class=\"line\">    <span class=\"comment\">//调用云函数获取openid</span></span><br><span class=\"line\">    wx.cloud.callFunction(&#123;</span><br><span class=\"line\">      name: <span class=\"string\">'login'</span>,</span><br><span class=\"line\">      data: &#123;&#125;,</span><br><span class=\"line\">      success: <span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">'[云函数] [login] user openid: '</span>, res.result.openid)</span><br><span class=\"line\">        wx.setStorageSync(<span class=\"string\">\"openid\"</span>, res.result.openid)</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      fail: <span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.error(<span class=\"string\">'[云函数] [login] 调用失败'</span>, err)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * 生命周期函数--监听页面初次渲染完成</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  onReady: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"comment\">//发送给自己模版消息</span></span><br><span class=\"line\">  button_one(e) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> form_id = e.detail.formId</span><br><span class=\"line\">    <span class=\"keyword\">let</span> date = <span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> data = <span class=\"built_in\">JSON</span>.stringify(&#123;</span><br><span class=\"line\">      <span class=\"string\">\"keyword1\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"value\"</span>: date</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">\"keyword2\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"value\"</span>: <span class=\"string\">\"2015年01月05日 12:30\"</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    <span class=\"comment\">//调用云函数发送模版消息</span></span><br><span class=\"line\">    wx.cloud.callFunction(&#123;</span><br><span class=\"line\">      name: <span class=\"string\">'moban'</span>,</span><br><span class=\"line\">      data: &#123;</span><br><span class=\"line\">        openid: wx.getStorageSync(<span class=\"string\">\"openid\"</span>),</span><br><span class=\"line\">        template_id: <span class=\"string\">\"Lwh1NYwTUzHIjDwWlbPVhUJWQLW__nLkj31p2lMH8AM\"</span>,</span><br><span class=\"line\">        page: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">        form_id,</span><br><span class=\"line\">        data,</span><br><span class=\"line\">        emphasis_keyword: <span class=\"string\">\"keyword1.DATA\"</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      success: <span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">'[云函数] [login] : '</span>, res)</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      fail: <span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.error(<span class=\"string\">'[云函数] [login] 调用失败'</span>, err)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"comment\">//调用云函数发送给指定用户</span></span><br><span class=\"line\">  button_two(e) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(e.detail.value.input)</span><br><span class=\"line\">    <span class=\"keyword\">let</span> value = e.detail.value.input <span class=\"comment\">//获取输入</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> week = <span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>() - (<span class=\"number\">1000</span> * <span class=\"number\">60</span> * <span class=\"number\">60</span> * <span class=\"number\">24</span> * <span class=\"number\">7</span>) <span class=\"comment\">//建立7天时间戳</span></span><br><span class=\"line\">    <span class=\"comment\">//储存formId，并打时间戳</span></span><br><span class=\"line\">    db.collection(<span class=\"string\">'formId'</span>).add(&#123;</span><br><span class=\"line\">        data: &#123;</span><br><span class=\"line\">          openid: wx.getStorageSync(<span class=\"string\">\"openid\"</span>),</span><br><span class=\"line\">          formId: e.detail.formId,</span><br><span class=\"line\">          date: (<span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>()).valueOf()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      .then(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(res)</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    <span class=\"comment\">//获取formId数据 </span></span><br><span class=\"line\">    db.collection(<span class=\"string\">'formId'</span>).where(&#123;</span><br><span class=\"line\">      _openid: <span class=\"string\">\"ogff70LGj__6xlA_lXbB-KoBWEo0\"</span>,</span><br><span class=\"line\">      date: _.gt(week) <span class=\"comment\">//获取7天内</span></span><br><span class=\"line\">    &#125;).get().then(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"built_in\">console</span>.log(res.data)</span><br><span class=\"line\">      <span class=\"keyword\">var</span> formIdList = res.data</span><br><span class=\"line\">      <span class=\"keyword\">let</span> date = <span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>();</span><br><span class=\"line\">      <span class=\"keyword\">let</span> data = <span class=\"built_in\">JSON</span>.stringify(&#123;</span><br><span class=\"line\">        <span class=\"string\">\"keyword1\"</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">\"value\"</span>: value</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">\"keyword2\"</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">\"value\"</span>: date</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      <span class=\"comment\">//调用云函数发送模版消息</span></span><br><span class=\"line\">      wx.cloud.callFunction(&#123;</span><br><span class=\"line\">        name: <span class=\"string\">'moban'</span>,</span><br><span class=\"line\">        data: &#123;</span><br><span class=\"line\">          openid: formIdList[<span class=\"number\">0</span>].openid,</span><br><span class=\"line\">          template_id: <span class=\"string\">\"Lwh1NYwTUzHIjDwWlbPVhUJWQLW__nLkj31p2lMH8AM\"</span>,</span><br><span class=\"line\">          page: <span class=\"string\">\"/pages/fromID/index?sender_openid=\"</span> + wx.getStorageSync(<span class=\"string\">\"openid\"</span>) + <span class=\"string\">\"&amp;value=\"</span> + value, <span class=\"comment\">//携带参数</span></span><br><span class=\"line\">          form_id: formIdList[<span class=\"number\">0</span>].formId,</span><br><span class=\"line\">          data,</span><br><span class=\"line\">          emphasis_keyword: <span class=\"string\">\"keyword1.DATA\"</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        success: <span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"built_in\">console</span>.log(<span class=\"string\">'模版消息发送成功: '</span>, res)</span><br><span class=\"line\">          <span class=\"keyword\">this</span>.remove(formIdList[<span class=\"number\">0</span>]._id); <span class=\"comment\">//调用删除formId函数</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail: <span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"built_in\">console</span>.error(<span class=\"string\">'模版消息发送失败：'</span>, err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  button_three(e) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(e.detail.formId)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>())</span><br><span class=\"line\">    db.collection(<span class=\"string\">'formId'</span>).add(&#123;</span><br><span class=\"line\">        data: &#123;</span><br><span class=\"line\">          openid: wx.getStorageSync(<span class=\"string\">\"openid\"</span>),</span><br><span class=\"line\">          formId: e.detail.formId,</span><br><span class=\"line\">          date: (<span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>()).valueOf()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      .then(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(res)</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"comment\">//回复消息</span></span><br><span class=\"line\">  receive(e) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(e.detail.value.input)</span><br><span class=\"line\">    <span class=\"keyword\">let</span> value = e.detail.value.input</span><br><span class=\"line\">    <span class=\"keyword\">let</span> week = <span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>() - (<span class=\"number\">1000</span> * <span class=\"number\">60</span> * <span class=\"number\">60</span> * <span class=\"number\">24</span> * <span class=\"number\">7</span>)</span><br><span class=\"line\">    db.collection(<span class=\"string\">'formId'</span>).add(&#123;</span><br><span class=\"line\">        data: &#123;</span><br><span class=\"line\">          openid: wx.getStorageSync(<span class=\"string\">\"openid\"</span>),</span><br><span class=\"line\">          formId: e.detail.formId,</span><br><span class=\"line\">          date: (<span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>()).valueOf()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      .then(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(res)</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    db.collection(<span class=\"string\">'formId'</span>).where(&#123;</span><br><span class=\"line\">      _openid: <span class=\"keyword\">this</span>.data.receiveData.sender_openid,</span><br><span class=\"line\">      date: _.gt(week)</span><br><span class=\"line\">    &#125;).get().then(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"built_in\">console</span>.log(res.data)</span><br><span class=\"line\">      <span class=\"keyword\">var</span> formIdList = res.data</span><br><span class=\"line\">      <span class=\"keyword\">let</span> date = <span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>();</span><br><span class=\"line\">      <span class=\"keyword\">let</span> data = <span class=\"built_in\">JSON</span>.stringify(&#123;</span><br><span class=\"line\">        <span class=\"string\">\"keyword1\"</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">\"value\"</span>: value</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">\"keyword2\"</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">\"value\"</span>: date</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      wx.cloud.callFunction(&#123;</span><br><span class=\"line\">        name: <span class=\"string\">'moban'</span>,</span><br><span class=\"line\">        data: &#123;</span><br><span class=\"line\">          openid: formIdList[<span class=\"number\">0</span>].openid,</span><br><span class=\"line\">          template_id: <span class=\"string\">\"Lwh1NYwTUzHIjDwWlbPVhUJWQLW__nLkj31p2lMH8AM\"</span>,</span><br><span class=\"line\">          page: <span class=\"string\">\"/pages/fromID/index?sender_openid=\"</span> + wx.getStorageSync(<span class=\"string\">\"openid\"</span>) + <span class=\"string\">\"&amp;value=\"</span> + value,</span><br><span class=\"line\">          form_id: formIdList[<span class=\"number\">0</span>].formId,</span><br><span class=\"line\">          data,</span><br><span class=\"line\">          emphasis_keyword: <span class=\"string\">\"keyword1.DATA\"</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        success: <span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"built_in\">console</span>.log(<span class=\"string\">'模版消息发送成功: '</span>, res)</span><br><span class=\"line\">          <span class=\"keyword\">this</span>.remove(formIdList[<span class=\"number\">0</span>]._id);</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail: <span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"built_in\">console</span>.error(<span class=\"string\">'模版消息发送失败：'</span>, err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"comment\">//调用云函数删除使用过的formId数据</span></span><br><span class=\"line\">  remove(id) &#123;</span><br><span class=\"line\">    wx.cloud.callFunction(&#123;</span><br><span class=\"line\">      name: <span class=\"string\">'remove'</span>,</span><br><span class=\"line\">      data: &#123;</span><br><span class=\"line\">        id,</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      success: <span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">'删除成功：'</span>, res)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (res.result.stats.removed == <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">          wx.showToast(&#123;</span><br><span class=\"line\">            title: <span class=\"string\">'删除formId成功'</span>,</span><br><span class=\"line\">          &#125;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      fail: <span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">'删除失败：'</span>, err)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n","categories":[],"tags":[{"name":"微信小程序","path":"api/tags/微信小程序.json"}]}